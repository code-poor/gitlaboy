#!/usr/bin/env node
const checkRoot = require('../utils/checkRoot');
if (!checkRoot()) { return }
const chalk = require('chalk');

const inquirer = require('inquirer');
const { getMergeRequests, mergeMr } = require('../utils');
const getConfig = require('../utils/getConfig');
const config = getConfig();
const review = async () => {
    const mrs = await getMergeRequests({ assigneeName: 'zhanghelin' });
    console.log(chalk.yellow(`å½“å‰ç”¨æˆ·ä¸º: ${config.baseConfig['gitUser-name']}`));
    console.log(chalk.green(`æ­£åœ¨æŸ¥è¯¢å®¡æ ¸äººçš„å¾…å®¡æ ¸mr: `));
    if(!mrs?.length) {
        return console.log(chalk.red('æš‚æ— mrå®¡æ ¸'))
    }
    const statusMap = {
        can_be_merged: 'å…è®¸åˆå¹¶âœ…',
        unchecked: 'è¿˜æœªæ£€æŸ¥â³è¯·ç¨åå†è¯•',
        checking: 'æ£€æŸ¥ä¸­â³è¯·ç¨åå†è¯•' ,
        cannot_be_merged:'å†²çªå¼‚å¸¸âŒ',
        cannot_be_merged_recheck: 'é‡å¤æ£€æŸ¥å¤±è´¥âŒ'
    }
    const res = await inquirer
        .prompt([{
            type: 'checkbox',
            name: 'mrs',
            message: `å¤šé€‰å®¡æ ¸é€šè¿‡`,
            choices: mrs.map((mr) => ({ value: mr, name: `${statusMap[mr.merge_status]} [${mr.iid}] ${mr.title} | ${mr.source_branch} => ${mr.target_branch} ğŸ‘¨â€ğŸ’»â€${mr.author.name}` }))
        }
        ])
    const selectedMrs = res.mrs;
    for (let mr of selectedMrs) {
        if(mr.merge_status !== 'can_be_merged') {
            console.log(chalk.red(`[${mr.iid}]åˆå¹¶å¤±è´¥ï¼ å½“å‰çŠ¶æ€ä¸º: ${statusMap[mr.merge_status]}`));
            continue
        }
        console.log(chalk.yellow(`å¼€å§‹åˆå¹¶ [${mr.iid}]...`));
        const mrRes = await mergeMr({ projectId: mr.project_id, mergerequestIId: mr.iid })
        // console.log(mrRes);
        if(mrRes.state === 'merged') {
            console.log(chalk.green(`åˆå¹¶ [${mr.iid}] ${mr.title} æˆåŠŸï¼`));
        }else{
            console.log(chalk.red(`æœªèƒ½æ­£å¸¸åˆå¹¶ [${mr.iid}] ${mr.title} ${mr.web_url}`));
        }
    }
}
review()